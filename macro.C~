#include "RooExpOfPolyTimesXBinned.h"
#include "RooExpOfPolyTimesX.h"

void macro()
{


  RooRealVar B_plus_M("B_plus_M", "M_{visible}", 4800, 6700, "MeV");
  RooRealVar misPT("misPT", "p_{#perp}", 0, 5000, "MeV");

  std::string combfile ="/vols/lhcb/palvare1/B2Kee_Kmumu/Marcin/B2XMuMu_Line_Strip21_Kemu_presel.root";
  std::string combtree ="DecayTree";
  std::string combcuts = "K_Kst_isMuon == 0";
  std::vector<std::string> varset = {"misPT", "B_plus_M","K_Kst_isMuon"};
  

  TFile* fComb = new TFile(combfile.c_str());
  TTree* tComb = (TTree*)fComb->Get(combtree.c_str());
  
  RooRealVar *var;
  RooArgSet argset;
     
  tComb->SetBranchStatus("*",0);
  for(vector<string>::const_iterator i = varset.begin(); i != varset.end(); ++i) 
  {
    tComb->SetBranchStatus((*i).c_str(), 1);
    if (*i=="B_plus_M" || *i=="misPT") continue;
    var = new RooRealVar((*i).c_str(),(*i).c_str(),-10,10);
    argset.add(*var);
  }
  
  argset.add(B_plus_M);
  argset.add(misPT);

  RooBinning mass_binning(floor((-4800+6200)/40.),4800,6200,"mass_binning");
  RooBinning misPT_binning(40,0,5000,"misPT_binning");
  
  B_plus_M.setBinning(mass_binning );
  misPT.setBinning( misPT_binning );

  RooRealVar l1Kee("l1Kee", "l1Kee", +2.3e-3, -1e-1, 5e-1);
  RooRealVar l2Kee("l2Kee", "l2Kee", +4.9e-3, -1e-1, 1e-1);
  RooRealVar l3Kee("l3Kee", "l3Kee", -4.1e-7, -1e-5, 1e-5);
  RooRealVar l4Kee("l4Kee", "l4Kee", -4e-7, -1e-5, 1e-5);
  RooRealVar l5Kee("l5Kee", "l5Kee", 1e-10, -1e-9, 1e-9);
  // RooExpOfPolyTimesXBinned* combPDF =  new RooExpOfPolyTimesXBinned("combPDF", "combPDF", B_plus_M, misPT, 
  //                                                                   l1Kee, l2Kee, l3Kee,l4Kee, l5Kee,
  //                                                                   mass_binning, misPT_binning);

  RooExpOfPolyTimesXBinned* combPDF =  new RooExpOfPolyTimesXBinned("combPDF", "combPDF", B_plus_M, misPT, 
                                                                    l1Kee, l2Kee, l3Kee,l4Kee, l5Kee);

  // RooExpOfPolyTimesX* combPDF =  new RooExpOfPolyTimesX("combPDF", "combPDF", B_plus_M, misPT, 
  //                                                       l1Kee, l2Kee, l3Kee,l4Kee, l5Kee);
  
  RooDataSet *dataSetComb = new RooDataSet("dataSetComb", "dataSetComb", tComb, argset, combcuts.c_str());
  RooDataHist *dataHistComb = dataSetComb->binnedClone("dataHistComb","dataHistComb");
  
  
  combPDF->fitTo(*dataHistComb);
  

  TH1D *model_bin_x = (TH1D*) combPDF->createIntegral(RooArgSet(misPT))->createHistogram("model_bin",B_plus_M);
  TH1D *model_bin_y = (TH1D*) combPDF->createIntegral(RooArgSet(B_plus_M))->createHistogram("model_bin",misPT);
  
  // model_bin_x->Scale(dataSetComb->sumEntries()*1.*mass_binning.averageBinWidth()/model_bin_x->GetSumOfWeights());
  // model_bin_y->Scale(dataSetComb->sumEntries()*1.*misPT_binning.averageBinWidth()/model_bin_y->GetSumOfWeights());

  model_bin_x->Scale(dataSetComb->sumEntries()*1./model_bin_x->GetSumOfWeights());
  model_bin_y->Scale(dataSetComb->sumEntries()*1./model_bin_y->GetSumOfWeights());
  
  model_bin_x->SetLineColor(kRed);
  model_bin_y->SetLineColor(kRed);
  
  // B_plus_M.setVal(5500);
  // misPT.setVal(2000);
  // double val = combPDF->getVal();
  // cout<<"combPDF = "<<val<<endl;


  TCanvas *cv1 = new TCanvas("cv1","cv1");
  RooPlot *frame_m = B_plus_M.frame();
  dataHistComb->plotOn(frame_m);
  combPDF->plotOn(frame_m);
  frame_m->Draw();
  model_bin_x->Draw("same");
  

  TCanvas *cv2 = new TCanvas("cv2","cv2");
  RooPlot *frame_pt = misPT.frame();
  dataHistComb->plotOn(frame_pt);
  combPDF->plotOn(frame_pt);
  frame_pt->Draw();
  model_bin_y->Draw("same");

}


